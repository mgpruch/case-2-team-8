

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(MASS)
library(purrr)
library(tidyr)
```

```{r read-in}
gym_data = read.csv("data_2022_2023.csv")
head(gym_data)
```

```{r}
#Cleaning hb issue
gym_data$Apparatus[gym_data$Apparatus == "hb"] <- "HB"
```

```{r Highest-Vault}
#Gymnasts vault two times, which is in the data as VT1 and VT2 (or if just once VT)
#Renaming these to all just be VT, because they're all data on vaults
gym_data$Apparatus[gym_data$Apparatus == "VT1"] <- "VT"
gym_data$Apparatus[gym_data$Apparatus == "VT2"] <- "VT"

#Making a US Binary variable
gym_data <- gym_data %>%
  mutate(Nation = case_when(Country == "USA" ~ "USA",
                              Country != "USA" ~ "Other"))
```

```{r}
men_gym_data %>%
  group_by(Apparatus)%>%
  summarize(max(Score))

women_gym_data %>%
  group_by(Apparatus)%>%
  summarize(max(Score))
```

```{r}
men_gym_data %>%
  group_by(LastName, Competition)%>%
  filter(Apparatus == "PB")%>%
  summarize(max(Score))
```
```{r}
gym_data %>%
  group_by(Competition, Round)%>%
  summarize(max(Score))
```
```{r}
women_gym_data %>%
  filter(Apparatus == "UB")%>%
  group_by(LastName, Rank, Competition)%>%
  summarize(min(Rank))%>%
  arrange(Rank)

women_gym_data %>%
  group_by(LastName)%>%
  filter(Rank == 1) %>%
  count(Rank == 1)%>%
  arrange(desc(n))
  
men_gym_data %>%
  group_by(LastName)%>%
  filter(Rank == 1) %>%
  count(Rank == 1)%>%
  arrange(desc(n))
```

```{r}
ggplot(data = gym_data, aes(x = Apparatus, y = E_Score))+
  geom_violin()
```

```{r}
men_gym_data %>%
  group_by(Apparatus, FirstName, LastName)%>%
  mutate(avg_score = mean(Score))%>%
  select(FirstName, LastName, avg_score)

avg_rank_men <- men_gym_data %>%
  group_by(FirstName, LastName)%>%
  mutate(avg_rank = mean(Rank))%>%
  select(FirstName, LastName, avg_rank)%>%
  distinct(FirstName, LastName, avg_rank)%>%
  arrange(avg_rank)

avg_rank_men_na <- na.omit(avg_rank_men)
avg_rank_men_na
```

```{r}
hist(men_gym_data$Score)
hist(women_gym_data$Score)
hist(men_gym_data$Rank)
hist(women_gym_data$Rank)

```

```{r}
alpha <- 9
beta <- 2
x <- seq(0,1, length = 24434)
y <-dbeta(gym_data$Score, shape1 = alpha, shape2 = beta)

plot(x, y, type = "l", col = "blue", lwd = 2, xlab = "x", ylab = "Density",
     main = "Beta Distribution")

# Add labels and legend
legend("topright", legend = paste("Beta(", alpha, ",", beta, ")", sep = ""), col = "blue", lwd = 2)


curve(dbeta(x, shape1 = alpha, shape2 = beta), from = 0, to = 1, n = 22842,
      col = "blue", lwd = 2, xlab = "x", ylab = "Density",
      main = "Beta Distribution", type = "l")
```
```{r}
hist(uniques$Score)
x <- seq(0,1, length = 24434)
y <- dgamma(uniques$Score, shape = 2, rate = 1)
fit_gam <- fitdistr(uniques$Score, "gamma", start = list(shape = 2, rate = 1))
```


```{r}
problematic_groups <- cleaned_gym_data %>%
  filter(FirstName == "" | LastName == "" | FirstName == ".")%>%
  distinct()

# Filter out problematic groups from the original data
uniques <- cleaned_gym_data %>%
  anti_join(problematic_groups, by = c("FirstName", "LastName"))

uniques <- uniques %>%
  distinct(FirstName, LastName, Score, Country, Gender)

fit_norm <- fitdistr(uniques$Score, "normal")
print(fit_norm$estimate)
print(fit_gam$estimate)

mu <- fit_norm$estimate[1]
sd <- fit_norm$estimate[2]

likelihood_vector <- dnorm(uniques$Score, mean = mu, sd = sd)
uniques$Likelihood <- likelihood_vector
print(uniques[, c("Score", "Likelihood")])

quantile_95 <- qnorm(0.95, mean = mu, sd = sd)

usa <- subset(uniques, Country == "USA")

topUSA <- usa%>%
  filter(usa$Score >= quantile_95)

topUSA %>%
  group_by(FirstName, LastName, Gender)%>%
  mutate(mean_score = mean(Score))%>%
  arrange(desc(mean_score))%>%
  distinct(FirstName, LastName, mean_score)
```


```{r}
problematic_groups <- cleaned_gym_data %>%
  filter(FirstName == "" | LastName == "" | FirstName == ".")%>%
  distinct()

# Filter out problematic groups from the original data
uniques <- cleaned_gym_data %>%
  anti_join(problematic_groups, by = c("FirstName", "LastName"))

usa <- subset(uniques, Country == "USA")

mu <- list()
sd <- list()
name_store <- list()
for(i in 1:nrow(usa)){
  first_name <- usa$FirstName[i]
  last_name <- usa$LastName[i]
  name_store[[i]] <- paste(first_name, last_name, i , sep = "-")
  sub <- usa %>%
    subset(LastName == last_name)%>%
    subset(FirstName == first_name)
  sub_na <- na.omit(sub$Score)
  fits <- fitdistr(sub$Score, "normal")
  mu[[i]] <- as.numeric(fits$estimate[1])
  sd[[i]] <- as.numeric(fits$estimate[2])
}

my_tib <- tibble(Names = name_store, Mu = mu, SD = sd)
my_tib$Names <- sub("^(.*?-.*?)-.*", "\\1", my_tib$Names)

usa_unique_final <- my_tib %>%
  distinct(Names, Mu, SD)
```

```{r check-no-lost-info}
filtered_data <- cleaned_gym_data %>%
  filter(Country == "USA")%>%
  distinct(FirstName, LastName)%>%
  count(FirstName)%>%
  mutate(total = sum(n))

```

```{r}
n <- 1000
gymnasts <- 6
top_combos <- 10
usa_unique_final <- na.omit(usa_unique_final)
#simulate_composite_score <- function(selected_gymnasts) {
#  simulated_scores <- lapply(selected_gymnasts$Mu, function(mu) rnorm(length(mu), mean = mu, sd = #sd))
#  composite_score <- rowSums(do.call(cbind, simulated_scores))
#  return(sum(composite_score))
#}

simulate_composite_score <- function(selected_gymnasts) {
  simulated_scores <- list()
  composite_score <- 0
  for (i in 1: nrow(selected_gymnasts)) {
    mu <- as.numeric(selected_gymnasts$Mu[i])
    dev <- as.numeric(selected_gymnasts$SD[i])
    simulated_scores[[i]] <- rnorm(1, mean = mu, sd = dev)
    composite_score <- composite_score + as.numeric(simulated_scores[[i]])
    print(composite_score)
  }
  
  return(composite_score)
}

results <- replicate(n, {
  sampled_gymnasts <- usa_unique_final[sample(nrow(usa_unique_final), gymnasts, replace = FALSE),]
  composite_score <- simulate_composite_score(sampled_gymnasts)
  results_entry <- c(Gymnasts = paste(sampled_gymnasts$Names, collapse = ", "), Composite_Score = composite_score)
  results_entry
})
results
```

```{r}
num_samples <- 1000

run_sim <- function(mu, sd, num_samples) {
  rnorm(num_samples, mean = mu, sd = sd)
}

for(i in 1:nrow(uniques)){
  name <- name_store[i]
  mu <- mu[[i]]
  sd <- sd[[i]]
  
  data <- run_sim(name, mu, sd, num_samples)
  simulated_scores <- bind_rows(simulated_scores, tibble(Score = simulated_data, Name = name))
}
```


