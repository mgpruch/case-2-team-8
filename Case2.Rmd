---
title: "Case2"
output:
  pdf_document: default
  html_document: default
date: "2023-11-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(MASS)
library(purrr)
library(tidyr)
```

```{r read-in}
gym_data = read.csv("cleanedfinalgymnastdata.csv")
head(gym_data)
```

## Introduction

As the Paris 2024 Olympic Games draw closer, the United States gymnastics program get ready to continue their dominance. The US women's artistic gymnastics team is one of the most decorated nations in the sport. The program has won three team gold medals at the 1996, 2012, and 2016 Olympics seven team gold medals at the World Championships. The program also trained the most decorated female gymnast - Simone Biles - who holds 37 world and Olympic medals. Beyond just their success in the gym, the program has created an international hype around them with their Olympic gold medal teams receiving the nicknames of the Magnificent Seven, the Fierce Five, and the Final Five. At their last Olympic showing, they attracted an average of 17.4 million total viewers for their appearance in the finals. While receiving less of a media frenzy than the women's team, the US men's artistic gymnastics team are still strong competitors. Although they received no medals in Tokyo, the program has achieved 6 medals in their history and look to make a strong appearance in Paris.

In order to make a strong showing from both teams and continue the legacy of the women's program, choosing the best possible team is essential. USA Gymnastics has nearly 200,000 members from their beginning training to their elite levels, but few can be taken to the international stage to represent their country. Both teams will only be allowed to bring five members to the Paris 2024 Olympics. The women's team will compete on four apparatuses: vault, uneven bars, balance beam, and floor exercise. The men's team will compete on six apparatuses: floor exercise, pommel horse, still rings, vault, parallel bars, and high bar. Both teams will also compete in the team and individual all-around, allowing for 6 opportunities to medal for the women and 8 for the men. Out of these 5 member teams, competition will follow a 5-4-3 format (4 members out of the 5 compete on each apparatus, and the top 3 scores count). In the team all-around this changes to a 5-3-3 format, so every score counts for the 3 members chosen to compete. For the individual competitions, only 2 gymnasts max per country can qualify to move on to the finals.

With all of these considerations in terms of format and competition stages, selecting a team is very challenging. Selection takes into consideration not only scores from previous competitions, but also protecting the ability to defend a medal or title. It is more than just looking at who has the highest score, since a team has to be selected that can compete across all of these events and do their best at each apparatus. This selection is normally done by USA Gymnastics (for the women it was done by the Karolyis before the recent scandal), but we will create a more analytical way to select the team. Our analysis is centered around the goal of selecting 5-member men and women's gymnastics teams that will maximize medal counts at the Paris 2024 Olympic Games. 

To do this, we are assessing data from past performances at recent competitions. Each of these competitions have scores for a gymnast's performance at a competition on one apparatus. These scores are a combination of an execution score (E Score) and a difficulty score (D Score). There also is a possible penalty that can be applied to a gymnasts score. 

## Beginning Exploratory Data Analysis

```{r}
#Cleaning hb issue
gym_data$Apparatus[gym_data$Apparatus == "hb"] <- "HB"
```

```{r Highest-Vault}
#Gymnasts vault two times, which is in the data as VT1 and VT2 (or if just once VT)
#Renaming these to all just be VT, because they're all data on vaults
gym_data$Apparatus[gym_data$Apparatus == "VT1"] <- "VT"
gym_data$Apparatus[gym_data$Apparatus == "VT2"] <- "VT"

#Making a US Binary variable
gym_data <- gym_data %>%
  mutate(Nation = case_when(Country == "USA" ~ "USA",
                              Country != "USA" ~ "Other"))
```

```{r}
#Looking at distribution of score across different events
p <- ggplot(data = gym_data, mapping = aes(x = Apparatus, y = Score, fill = Gender)) + 
  geom_boxplot() + theme_bw() + labs(title = "Distribution of Score of Each Apparatus by Gender") 

p + scale_fill_discrete(name = "Gender", labels = c("Men", "Women"))

#Initial issue is that some rows have a lower score hb that is making it seem like there are two categories of high bar
```
```{r MenWomen}
women_gym_data <- gym_data %>%
  filter(Gender == "w")

men_gym_data <- gym_data %>%
  filter(Gender == "m")
```



```{r}
library(dplyr)
ggplot(data = women_gym_data, mapping = aes(x = Apparatus, y = Score, fill = Nation)) + 
  geom_violin() + theme_bw() + labs(title = "Distribution of Scores Across Appartus for US Women vs. Other Gymnasts") 

ggplot(data = men_gym_data, mapping = aes(x = Apparatus, y = Score, fill = Nation)) + 
  geom_violin() + theme_bw() + labs(title = "Distribution of Scores Across Appartus for US Men vs. Other Gymnasts") 
```

```{r}
men_gym_data <- men_gym_data %>%
  mutate(name = paste(FirstName, LastName)) 

men_gym_data %>% filter(Country == "USA") %>% group_by(name) %>% count()

women_gym_data <- women_gym_data %>%
  mutate(name = paste(FirstName, LastName)) 

women_gym_data %>% filter(Country == "USA") %>% group_by(name) %>% count()
```

```{r}
us_men_gym_data <- men_gym_data %>% filter(Country == "USA")
us_womens_gym_data <- women_gym_data %>% filter(Country == "USA")
```

## Methodology

# 1. Determining Constraint Level

In order to narrow down the field from the 163 men and 59 womens American gymnasts included in our dataset, we aimed to set a constraint level that a gymnast must meet to be considered. To do this, we first filtered out any gymnast that hadn't competed in 2023. This was due to both the need for relevant data to assess what state the gymnast will be in during the 2024 competitions, but also to weed out anyone that has been injured so couldn't recently compete or who has retired after the 2022 competitions. Taking out gymnasts who hadn't competed in the past year reduced the size of our selection pool to 142 men and 47 women. 

```{r}
#Get rid of all gymnasts that did not compete in 2023
library(stringr)
us_womens_gym_data$Year <- str_sub(us_womens_gym_data$Date, -4)
us_men_gym_data$Year <- str_sub(us_men_gym_data$Date, -4)

length(unique(us_men_gym_data$name))
length(unique(us_womens_gym_data$name))

us_womens_gym_data <- us_womens_gym_data %>%
  group_by(name) %>%
  filter(max(Year) == 2023)

us_men_gym_data <- us_men_gym_data %>%
  group_by(name) %>%
  filter(max(Year) == 2023)

length(unique(us_men_gym_data$name))
length(unique(us_womens_gym_data$name))
```

We also filtered out gymnasts that had too low of an average score to warrant further consideration and even further reduce our selection pool. To do this, we calculated the average score across all competitions and apparatuses for each US gymnast (both male and female). We then found the first quartile value for each gender's average score. This means the average score that 25% of the average scores for male and female gymnasts respectively fell below this value. The 25th percentile score for US women gymnasts was 12.15156 and 12.15000 for men. After filtering out any competitors who had average scores below that, we were left with 106 men and 35 women. 

```{r}

length(unique(us_men_gym_data$name))
length(unique(us_womens_gym_data$name))
w_avs <- us_womens_gym_data %>%
  group_by(name) %>%
  summarise(mean(Score))
names(w_avs) <- c("name", "avgScore")

quantile(w_avs$avgScore)

m_avs <- us_men_gym_data %>%
  group_by(name) %>%
  summarise(mean(Score))
names(m_avs) <- c("name", "avgScore")

quantile(m_avs$avgScore)

us_womens_gym_data <- us_womens_gym_data %>%
  group_by(name) %>%
  filter(mean(Score) > 12.15156)
us_men_gym_data <- us_men_gym_data %>%
  group_by(name) %>%
  filter(mean(Score) > 12.15000)

length(unique(us_men_gym_data$name))
length(unique(us_womens_gym_data$name))
```



# Simulating Composite Scores

```{r}
problematic_groups <- cleaned_gym_data %>%
  filter(FirstName == "" | LastName == "" | FirstName == ".")%>%
  distinct()

# Filter out problematic groups from the original data
uniques <- cleaned_gym_data %>%
  anti_join(problematic_groups, by = c("FirstName", "LastName"))%>%
  filter(!is.na(Score))
usa <- subset(uniques, Country == "USA")
usa_men <- subset(usa, Gender == "m")
usa_women <- subset(usa, Gender == "w")

mu <- list()
sd <- list()
name_store <- list()
for(i in 1:nrow(usa_men)){
  first_name <- usa_men$FirstName[i]
  last_name <- usa_men$LastName[i]
  name_store[[i]] <- paste(first_name, last_name, i , sep = "-")
  sub <- usa_men %>%
    subset(LastName == last_name)%>%
    subset(FirstName == first_name)
  sub_na <- na.omit(sub$Score)
  fits <- fitdistr(sub$Score, "normal")
  mu[[i]] <- as.numeric(fits$estimate[1])
  sd[[i]] <- as.numeric(fits$estimate[2])
}

men_tib <- tibble(Names = name_store, Mu = mu, SD = sd)
men_tib$Names <- sub("^(.*?-.*?)-.*", "\\1", men_tib$Names)

men_usa <- men_tib %>%
  distinct(Names, Mu, SD)

mu_2 <- list()
sd_2 <- list()
name_store_2 <- list()
for(i in 1:nrow(usa_women)){
  first_name <- usa_women$FirstName[i]
  last_name <- usa_women$LastName[i]
  name_store_2[[i]] <- paste(first_name, last_name, i , sep = "-")
  sub <- usa_women %>%
    subset(LastName == last_name)%>%
    subset(FirstName == first_name)
  sub_na <- na.omit(sub$Score)
  fits <- fitdistr(sub$Score, "normal")
  mu_2[[i]] <- as.numeric(fits$estimate[1])
  sd_2[[i]] <- as.numeric(fits$estimate[2])
}

women_tib <- tibble(Names = name_store_2, Mu = mu_2, SD = sd_2)
women_tib$Names <- sub("^(.*?-.*?)-.*", "\\1", women_tib$Names)

women_usa <- women_tib %>%
  distinct(Names, Mu, SD)
```

```{r}
set.seed(1212)
n <- 50000
gymnasts <- 6
top_combos <- 10
usa_unique_final <- na.omit(men_usa)
  
#simulate_composite_score <- function(selected_gymnasts) {
#  simulated_scores <- lapply(selected_gymnasts$Mu, function(mu) rnorm(length(mu), mean = mu, sd = #sd))
#  composite_score <- rowSums(do.call(cbind, simulated_scores))
#  return(sum(composite_score))
#}

simulate_composite_score <- function(selected_gymnasts) {
  simulated_scores <- list()
  composite_score <- 0
  for (i in 1: nrow(selected_gymnasts)) {
    if(!is.na(selected_gymnasts$SD[i])){
      dev <- as.numeric(selected_gymnasts$SD[i])
    } else{
      dev = 0
    }
    mu <- as.numeric(selected_gymnasts$Mu[i])
    if (!is.na(dev) && abs(dev) < 1e-10) {
      simulated_scores[[i]] <- mu
    } else {
      simulated_scores[[i]] <- rnorm(1, mean = mu, sd = dev)
    }
    composite_score <- composite_score + as.numeric(simulated_scores[[i]])
#    cat("Iteration:", i, "mu:", mu, "dev:", dev, "Simulated Score:", simulated_scores[[i]], "Composite Score:", composite_score, "\n")
  }  
#  print(composite_score)
  return(composite_score)
}

results <- replicate(n, {
  sampled_gymnasts <- usa_unique_final[sample(nrow(usa_unique_final), gymnasts, replace = FALSE),]
  composite_score <- simulate_composite_score(sampled_gymnasts)
  results_entry <- c(Gymnasts = paste(sampled_gymnasts$Names, collapse = ", "), Composite_Score = composite_score)
  results_entry
})
results_tibble <- as_tibble(t(results))

top_combinations_df <- results_tibble %>%
  arrange(desc(Composite_Score)) %>%
  slice_head(n = 10)

print(top_combinations_df)
```

```{r}
n <- 50000
gymnasts <- 6
top_combos <- 10
usa_unique_final <- na.omit(women_usa)

#simulate_composite_score <- function(selected_gymnasts) {
#  simulated_scores <- lapply(selected_gymnasts$Mu, function(mu) rnorm(length(mu), mean = mu, sd = #sd))
#  composite_score <- rowSums(do.call(cbind, simulated_scores))
#  return(sum(composite_score))
#}

simulate_composite_score <- function(selected_gymnasts) {
  simulated_scores <- list()
  composite_score <- 0
  for (i in 1: nrow(selected_gymnasts)) {
    if(!is.na(selected_gymnasts$SD[i])){
      dev <- as.numeric(selected_gymnasts$SD[i])
    } else{
      dev = 0
    }
    mu <- as.numeric(selected_gymnasts$Mu[i])
    if (!is.na(dev) && abs(dev) < 1e-10) {
      simulated_scores[[i]] <- mu
    } else {
      simulated_scores[[i]] <- rnorm(1, mean = mu, sd = dev)
    }
    composite_score <- composite_score + as.numeric(simulated_scores[[i]])
#    cat("Iteration:", i, "mu:", mu, "dev:", dev, "Simulated Score:", simulated_scores[[i]], "Composite Score:", composite_score, "\n")
  }  
#  print(composite_score)
  return(composite_score)
}

results <- replicate(n, {
  sampled_gymnasts <- usa_unique_final[sample(nrow(usa_unique_final), gymnasts, replace = FALSE),]
  composite_score <- simulate_composite_score(sampled_gymnasts)
  results_entry <- c(Gymnasts = paste(sampled_gymnasts$Names, collapse = ", "), Composite_Score = composite_score)
  results_entry
})
results_tibble <- as_tibble(t(results))

top_combinations_df <- results_tibble %>%
  arrange(desc(Composite_Score)) %>%
  slice_head(n = 10)

print(top_combinations_df)
```

